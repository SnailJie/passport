<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>{% block title %}{% endblock %} - SaintIC Passport</title>
    {% include "public/header.html" %}
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <link rel="stylesheet" href="/static/css/global.css">
    <link rel="stylesheet" href="/static/spop-0.1.3/spop.min.css">
    {% block head %}{% endblock %}
</head>
<body>

<!--顶部导航-->
<div class="fly-header layui-bg-black">
    <div class="layui-container">
        <a class="fly-logo" href="/"><img src="/static/images/logo.png" alt="Passport"></a>
        {% if g.signin %}
        <ul class="layui-nav fly-nav-user">
            <li class="layui-nav-item">
                <a class="fly-nav-avatar" href="javascript:;">
                    &nbsp;&nbsp;&nbsp;<cite class="layui-hide-xs" id="nav_nickname"></cite>
                    <!--<i class="iconfont icon-renzheng layui-hide-xs" title="已实名、未实名"></i>
                    <i class="layui-badge fly-badge-vip layui-hide-xs">VIP3</i>-->
                    <img id="nav_avatar">
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="{{ url_for('front.userset') }}"><i class="layui-icon">&#xe620;</i>基本设置</a></dd>
                    <!--<dd><a href="{{ url_for('front.usersecurity') }}"><i class="layui-icon">&#xe631;</i>安全设置</a></dd>-->
                    <dd><a href="{{ url_for('front.usermsg') }}"><i class="iconfont icon-tongzhi" style="top: 4px;"></i>我的消息</a></dd>
                    <!--
                    <dd><a href="user/home.html"><i class="layui-icon" style="margin-left: 2px; font-size: 22px;">&#xe68e;</i>我的主页</a></dd>
                    -->
                    <hr style="margin: 5px 0;">
                    <dd><a href="{{ url_for('front.signOut') }}" style="text-align: center;">退出</a></dd>
                </dl>
            </li>
        </ul>
        {% endif %}
    </div>
</div>

<div class="layui-container fly-marginTop fly-user-main">
    {% block leftNav %}
    <!--左侧垂直导航-->
    <ul class="layui-nav layui-nav-tree layui-inline" lay-filter="user">
        <!--
        <li class="layui-nav-item {% if request.endpoint == 'front.userset' %}layui-this{% endif %}">
            <a href="home.html"><i class="layui-icon">&#xe609;</i>我的主页</a>
        </li>
        -->
        <li class="layui-nav-item {% if request.endpoint == 'front.userset' %}layui-this{% endif %}">
            <a href="{{ url_for('front.userset') }}"><i class="layui-icon">&#xe620;</i>基本设置</a>
        </li>
        <!--
        <li class="layui-nav-item {% if request.endpoint == 'front.usersecurity' %}layui-this{% endif %}">
            <a href="{{ url_for('front.usersecurity') }}"><i class="layui-icon">&#xe631;</i>安全设置</a>
        </li>
        -->
        <li class="layui-nav-item {% if request.endpoint == 'front.usermsg' %}layui-this{% endif %}">
            <a href="{{ url_for('front.usermsg') }}"><i class="layui-icon">&#xe611;</i>我的消息</a>
        </li>
        {% if tpl_adminlogin_required() %}
        <!--
        <li class="layui-nav-item {% if request.endpoint == 'front.sysmanager' %}layui-this{% endif %}">
            <a href="{{ url_for('front.sysmanager') }}"><i class="layui-icon">&#xe631;</i>系统设置</a>
        </li>
        -->
        <li class="layui-nav-item {% if request.endpoint == 'front.userapp' %}layui-this{% endif %}">
            <a href="{{ url_for('front.userapp') }}"><i class="layui-icon">&#xe857;</i>应用管理</a>
        </li>
        {% endif %}
    </ul>
    <div class="site-tree-mobile layui-hide">
        <i class="layui-icon">&#xe602;</i>
    </div>
    <div class="site-mobile-shade"></div>
    <div class="site-tree-mobile layui-hide">
        <i class="layui-icon">&#xe602;</i>
    </div>
    <div class="site-mobile-shade"></div>
    {% endblock %}
    <!--主要内容-->
    {% block userpanel %}{% endblock %}
</div>

{% include "public/footer.html" %}
<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/spop-0.1.3/spop.min.js"></script>
<script type="text/javascript" src="/static/layui/layui.js"></script>
<script type="text/javascript">
//消息弹窗提示
function popup(msg) {
    spop({
        template: msg,
        position: 'top-center',
        autoclose: 5000
    });
}

//字符串安全检查
function safeCheck(s) {
    try {
        if (s.indexOf("'")!=-1||s.indexOf('"')!=-1||s.indexOf("?")!=-1||s.indexOf("%")!=-1||s.indexOf(";")!=-1||s.indexOf("*")!=-1||s.indexOf("=")!=-1||s.indexOf("\\")!=-1) {
            return false
        } else {
            return true;
        }
    }
    catch(e) {
        return false;
    }
}

{%- with messages = get_flashed_messages() %}
{%- if messages %}
{%- for msg in messages %}
popup('{{ msg }}');
{%- endfor %}
{%- endif %}
{%- endwith %}

{%- if g.signin %}
layui.use(["jquery", "element", "util", "layer"], function(){
    var $ = layui.jquery, element = layui.element, util = layui.util, layer = layui.layer;
    //手机设备的简单适配
    var treeMobile = $('.site-tree-mobile'), shadeMobile = $('.site-mobile-shade');
    treeMobile.on('click', function(){
        $('body').addClass('site-mobile');
    });
    shadeMobile.on('click', function(){
        $('body').removeClass('site-mobile');
    });
    //右下角工具
    util.fixbar({
        bgcolor: '#009688'
    });
    //获取用户信息
    $.ajax({
        url: "{{ url_for('api.userprofile', getBind=true) }}",
        async: false,
        success: function(res) {
            if (res.code==0) {
                //更新昵称
                $('#nav_nickname').text(res.data.nick_name || '');
                //更新头像
                $('#nav_avatar').attr('src', res.data.avatar || '/static/images/avatar/default.png');
                //缓存
                layui.cache.user = res.data;
                //更新消息
            } else {
                popup("拉取用户信息失败：" + res.msg);
            }
        },
        error: function() {
            popup("系统异常，请稍后再试");
        }
    });
    {%- if request.endpoint != "front.usermsg" %}
    //获取用户消息统计
    $.ajax({
        url: "{{ url_for('api.usermsg', Action='getCount', msgStatus=1)|safe }}",
        async: true,
        success: function(res) {
            console.log(res);
            if (res.code==0) {
                if (res.count==0) {
                    return;
                }
                //更新消息
                var elemUser = $('.fly-nav-user');
                var msg = $('<a class="fly-nav-msg" href="javascript:;" title="你有 '+ res.count +' 条未读消息">'+ res.count +'</a>');
                elemUser.append(msg);
                msg.on('click', function(){
                    location.href = "{{ url_for('front.usermsg') }}";
                });
                layer.tips('你有 '+ res.count +' 条未读消息', msg, {
                    tips: 3
                    ,tipsMore: true
                    ,fixed: true
                });
            } else {
                popup("拉取用户消息失败：" + res.msg);
            }
        }
    });
    {%- endif %}
});
{%- endif %}
</script>
{% block script %}{% endblock %}
</body>
</html>