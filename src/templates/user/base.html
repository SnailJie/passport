<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>{% block title %}{% endblock %} - SaintIC Passport</title>
    {% include "public/header.html" %}
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <link rel="stylesheet" href="/static/css/global.css">
    <link rel="stylesheet" href="/static/spop-0.1.3/spop.min.css">
    {% block head %}{% endblock %}
</head>
<body>

<!--顶部导航-->
<div class="fly-header layui-bg-black">
    <div class="layui-container">
        <a class="fly-logo" href="/"><img src="/static/images/logo.png" alt="layui"></a>
        {% if g.signin %}
        <ul class="layui-nav fly-nav-user">
            <li class="layui-nav-item">
                <a class="fly-nav-avatar" href="javascript:;">
                    <cite class="layui-hide-xs" id="nav_nickname"></cite>
                    <!--
                    <i class="iconfont icon-renzheng layui-hide-xs" title="认证信息：layui 作者"></i>
                    <i class="layui-badge fly-badge-vip layui-hide-xs">VIP3</i>
                    -->
                    <img id="nav_avatar">
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="{{ url_for('front.userset') }}"><i class="layui-icon">&#xe620;</i>基本设置</a></dd>
                    <!--
                    <dd><a href="user/message.html"><i class="iconfont icon-tongzhi" style="top: 4px;"></i>我的消息</a></dd>
                    <dd><a href="user/home.html"><i class="layui-icon" style="margin-left: 2px; font-size: 22px;">&#xe68e;</i>我的主页</a></dd>
                    -->
                    <hr style="margin: 5px 0;">
                    <dd><a href="{{ url_for('front.signOut') }}" style="text-align: center;">退出</a></dd>
                </dl>
            </li>
        </ul>
        {% endif %}
    </div>
</div>

<div class="layui-container fly-marginTop fly-user-main">
    {% block leftNav %}
    <!--左侧垂直导航-->
    <ul class="layui-nav layui-nav-tree layui-inline" lay-filter="user">
        <!--
        <li class="layui-nav-item {% if request.endpoint == 'front.userset' %}layui-this{% endif %}">
            <a href="home.html"><i class="layui-icon">&#xe609;</i>我的主页</a>
        </li>
        -->
        <li class="layui-nav-item {% if request.endpoint == 'front.userset' %}layui-this{% endif %}">
            <a href="{{ url_for('front.userset') }}"><i class="layui-icon">&#xe620;</i>基本设置</a>
        </li>
        {% if tpl_adminlogin_required() %}
        <li class="layui-nav-item {% if request.endpoint == 'front.userapp' %}layui-this{% endif %}">
            <a href="{{ url_for('front.userapp') }}"><i class="layui-icon">&#xe857;</i>应用管理</a>
        </li>
        {% endif %}
        <!--
        <li class="layui-nav-item {% if request.endpoint == 'front.userset' %}layui-this{% endif %}">
            <a href="message.html"><i class="layui-icon">&#xe611;</i>我的消息</a>
        </li>
        -->
    </ul>
    <div class="site-tree-mobile layui-hide">
        <i class="layui-icon">&#xe602;</i>
    </div>
    <div class="site-mobile-shade"></div>
    <div class="site-tree-mobile layui-hide">
        <i class="layui-icon">&#xe602;</i>
    </div>
    <div class="site-mobile-shade"></div>
    {% endblock %}
    <!--主要内容-->
    {% block userpanel %}{% endblock %}
</div>

{% include "public/footer.html" %}
<script src="/static/spop-0.1.3/spop.min.js"></script>
<script src="/static/layui/layui.js"></script>
<script type="text/javascript">
//消息弹窗提示
function popup(msg) {
    spop({
        template: msg,
        position: 'top-center',
        autoclose: 5000
    });
}
//字符串安全检查
function safeCheck(s) {
    try {
        if (s.indexOf("'")!=-1||s.indexOf('"')!=-1||s.indexOf("?")!=-1||s.indexOf("%")!=-1||s.indexOf(";")!=-1||s.indexOf("*")!=-1||s.indexOf("=")!=-1||s.indexOf("\\")!=-1) {
            return false
        } else {
            return true;
        }
    }
    catch(e) {
        return false;
    }
}
{%- with messages = get_flashed_messages() %}
{%- if messages %}
{%- for msg in messages %}
popup('{{ msg }}');
{%- endfor %}
{%- endif %}
{%- endwith %}

{%- if g.signin %}
layui.use("jquery", function(){
    var $ = layui.jquery;
    //获取用户信息
    $.ajax({
        url: "{{ url_for('api.userprofile', getBind=true) }}",
        success: function(res) {
            if (res.code==0) {
                //更新昵称
                $('#nav_nickname').text(res.data.nick_name || '');
                //更新头像
                $('#nav_avatar').attr('src', res.data.avatar || '/static/images/avatar/default.png');
                //缓存
                layui.cache.user = res.data;
            } else {
                popup("拉取用户信息失败，请刷新再试");
                popup(res.msg);
            }
        },
        error: function() {
            popup("系统异常，请稍后再试");
        }
    });
});
{%- endif %}
</script>
{% block script %}{% endblock %}
</body>
</html>